<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TikTok Social</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Arial,sans-serif;}
    body{background:#000;color:#fff;overflow:hidden;height:100vh;display:flex;flex-direction:column;}
    
    /* Header */
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#000;position:sticky;top:0;z-index:100;border-bottom:1px solid #2f2f2f;}
    .logo{font-size:20px;font-weight:bold;background:linear-gradient(45deg,#ff0050,#ff9000);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .header-icons{display:flex;gap:20px;}
    .header-icon{font-size:20px;cursor:pointer;}
    .badge{background:#ff0050;color:#fff;font-size:10px;padding:2px 6px;border-radius:12px;position:absolute;top:-5px;right:-5px;}

    /* Bottom Navigation */
    .bottom-nav{display:flex;background:#000;border-top:1px solid #2f2f2f;position:fixed;bottom:0;width:100%;z-index:100;padding:8px 0;}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;padding:4px 0;color:#b0b0b0;cursor:pointer;font-size:12px;}
    .nav-item.active{color:#fff;}
    .nav-icon{font-size:22px;margin-bottom:2px;}
    .nav-item.active .nav-icon{color:#ff0050;}

    /* Pages */
    .page{display:none;flex-direction:column;height:100%;overflow:hidden;}
    .page.active{display:flex;}

    /* Home Feed */
    .feed{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;scroll-snap-type:y mandatory;}
    .video-card{position:relative;width:100%;height:100vh;background:#000;scroll-snap-align:start;display:flex;align-items:center;justify-content:center;}
    video{width:100%;height:100%;object-fit:cover;background:#000;}
    .video-overlay{position:absolute;bottom:0;left:0;right:0;padding:20px 15px;background:linear-gradient(transparent,rgba(0,0,0,.7));}
    .user-info{display:flex;align-items:center;gap:12px;color:#fff;cursor:pointer;}
    .user-avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(45deg,#ff0050,#ff9000);display:flex;align-items:center;justify-content:center;font-size:20px;}
    .user-details{flex:1;}
    .username{font-weight:600;font-size:16px;}
    .caption{margin-top:8px;font-size:14px;line-height:1.4;}
    .hashtag{color:#84d8ff;}
    .actions{position:absolute;right:16px;bottom:100px;display:flex;flex-direction:column;gap:20px;align-items:center;}
    .action-btn{background:rgba(255,255,255,.1);width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;backdrop-filter:blur(10px);}
    .action-btn.liked{color:#ff0050;}
    .action-count{font-size:12px;margin-top:4px;font-weight:500;}

    /* Profile Page */
    .profile-page{background:#000;}
    .profile-header{padding:20px 16px;}
    .profile-top{display:flex;align-items:center;gap:20px;margin-bottom:20px;}
    .profile-avatar{width:90px;height:90px;border-radius:50%;background:linear-gradient(45deg,#ff0050,#ff9000);display:flex;align-items:center;justify-content:center;font-size:36px;}
    .profile-stats{flex:1;}
    .stats{display:flex;justify-content:space-around;text-align:center;}
    .stat-value{font-weight:bold;font-size:18px;}
    .stat-label{font-size:12px;color:#b0b0b0;margin-top:4px;}
    .profile-bio{margin:16px 0;}
    .bio-text{font-size:14px;color:#fff;margin-bottom:8px;}
    .bio-link{color:#84d8ff;font-size:14px;text-decoration:none;display:block;margin:4px 0;}
    .profile-actions{display:flex;gap:8px;margin:16px 0;}
    .edit-btn{flex:1;background:#2f2f2f;color:#fff;border:none;border-radius:8px;padding:10px;font-size:14px;cursor:pointer;}
    .follow-btn{background:#ff0050;color:#fff;border:none;border-radius:8px;padding:10px 20px;font-size:14px;cursor:pointer;}
    .follow-btn.following{background:#2f2f2f;}
    
    /* Settings Icon */
    .settings-icon{position:absolute;top:20px;right:20px;font-size:20px;color:#b0b0b0;cursor:pointer;}

    /* Drafts Section */
    .drafts-section{background:#111;padding:16px;margin:16px 0;border-radius:12px;}
    .drafts-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
    .drafts-title{font-size:16px;font-weight:600;}
    .drafts-stats{display:flex;gap:20px;}
    .draft-stat{text-align:center;}
    .draft-value{font-size:14px;font-weight:600;}
    .draft-label{font-size:11px;color:#b0b0b0;margin-top:2px;}
    
    /* Profile Videos Grid */
    .profile-videos{display:grid;grid-template-columns:repeat(3,1fr);gap:2px;}
    .profile-video{position:relative;aspect-ratio:9/16;background:#222;overflow:hidden;}
    .profile-video video{width:100%;height:100%;object-fit:cover;}
    .video-stats{position:absolute;bottom:0;left:0;right:0;padding:8px;background:linear-gradient(transparent,rgba(0,0,0,.7));font-size:12px;display:flex;align-items:center;gap:4px;}

    /* Friends Page */
    .friends-page{background:#000;}
    .friends-header{padding:16px;border-bottom:1px solid #2f2f2f;}
    .friends-title{font-size:20px;font-weight:600;margin-bottom:16px;}
    .friends-videos{display:grid;grid-template-columns:repeat(2,1fr);gap:2px;padding:10px;}
    .friend-video{position:relative;aspect-ratio:9/16;background:#222;overflow:hidden;}
    .friend-video video{width:100%;height:100%;object-fit:cover;}
    .friend-video-overlay{position:absolute;bottom:0;left:0;right:0;padding:8px;background:linear-gradient(transparent,rgba(0,0,0,.7));font-size:12px;}

    /* Inbox Page */
    .inbox-page{background:#000;}
    .inbox-header{padding:16px;border-bottom:1px solid #2f2f2f;}
    .inbox-title{font-size:20px;font-weight:600;margin-bottom:16px;}
    .inbox-tabs{display:flex;background:#111;border-radius:8px;padding:4px;margin-bottom:16px;}
    .inbox-tab{flex:1;text-align:center;padding:10px;border-radius:6px;cursor:pointer;font-size:14px;}
    .inbox-tab.active{background:#2f2f2f;color:#fff;}
    .user-list{flex:1;overflow-y:auto;}
    .user-item{display:flex;align-items:center;padding:16px;border-bottom:1px solid #2f2f2f;cursor:pointer;}
    .user-avatar{width:56px;height:56px;border-radius:50%;background:linear-gradient(45deg,#ff0050,#ff9000);display:flex;align-items:center;justify-content:center;font-size:20px;margin-right:12px;}
    .user-details{flex:1;}
    .user-name{font-weight:600;font-size:16px;margin-bottom:4px;}
    .user-status{font-size:13px;color:#b0b0b0;}
    .user-stats{text-align:right;}
    .followers-count{font-size:12px;color:#b0b0b0;}
    .follow-btn-small{background:#ff0050;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:12px;cursor:pointer;margin-top:4px;}
    .follow-btn-small.following{background:#2f2f2f;}

    /* Chat Page - Full Screen */
    .chat-page{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:1000;display:none;flex-direction:column;}
    .chat-header{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid #2f2f2f;}
    .chat-back{background:none;border:none;color:#fff;font-size:18px;margin-right:12px;cursor:pointer;}
    .chat-user{display:flex;align-items:center;gap:12px;flex:1;}
    .chat-avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(45deg,#ff0050,#ff9000);display:flex;align-items:center;justify-content:center;}
    .chat-info{flex:1;}
    .chat-name{font-weight:600;font-size:16px;}
    .chat-status{font-size:12px;color:#b0b0b0;}
    .chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;}
    .message{max-width:70%;padding:12px 16px;border-radius:18px;font-size:14px;line-height:1.4;}
    .message-sent{background:#ff0050;align-self:flex-end;border-bottom-right-radius:4px;}
    .message-received{background:#2f2f2f;align-self:flex-start;border-bottom-left-radius:4px;}
    .chat-input{display:flex;padding:12px 16px;gap:12px;border-top:1px solid #2f2f2f;}
    .chat-input input{flex:1;padding:12px 16px;border-radius:24px;background:#2f2f2f;border:none;outline:none;color:#fff;font-size:14px;}
    .chat-send{background:#ff0050;color:#fff;border:none;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;}

    /* Upload Modal */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);display:flex;align-items:flex-end;z-index:2000;display:none;}
    .modal-content{background:#000;width:100%;border-radius:24px 24px 0 0;padding:20px;}
    .modal-header{text-align:center;padding:10px 0 20px 0;border-bottom:1px solid #2f2f2f;}
    .modal-title{font-size:18px;font-weight:600;}
    .modal-options{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;padding:20px 0;}
    .modal-option{display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px;background:#111;border-radius:12px;cursor:pointer;}
    .modal-icon{width:48px;height:48px;border-radius:12px;background:linear-gradient(45deg,#ff0050,#ff9000);display:flex;align-items:center;justify-content:center;font-size:20px;}
    .modal-label{font-size:12px;text-align:center;}

    /* Gallery Upload Modal */
    .gallery-modal{background:#000;width:100%;height:100%;display:flex;flex-direction:column;}
    .gallery-header{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid #2f2f2f;}
    .gallery-title{font-size:18px;font-weight:600;}
    .gallery-close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer;}
    .gallery-content{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;}
    .upload-area{width:100%;max-width:400px;border:2px dashed #555;border-radius:12px;padding:40px;text-align:center;cursor:pointer;}
    .upload-icon{font-size:48px;color:#555;margin-bottom:16px;}
    .upload-text{font-size:16px;color:#b0b0b0;margin-bottom:8px;}
    .upload-subtext{font-size:14px;color:#777;}
    .upload-preview{width:100%;max-width:300px;max-height:300px;object-fit:contain;margin:20px 0;border-radius:8px;display:none;}
    .caption-input{width:100%;max-width:400px;padding:12px 16px;background:#2f2f2f;border:none;border-radius:8px;color:#fff;font-size:14px;margin:10px 0;outline:none;}
    .upload-actions{display:flex;gap:12px;width:100%;max-width:400px;margin-top:20px;}
    .upload-action{flex:1;padding:12px;border:none;border-radius:8px;font-size:14px;cursor:pointer;}
    .upload-cancel{background:#2f2f2f;color:#fff;}
    .upload-post{background:#ff0050;color:#fff;}

    /* Settings Modal */
    .settings-modal{background:#000;width:100%;height:70%;position:fixed;bottom:0;border-radius:20px 20px 0 0;display:none;flex-direction:column;z-index:2000;}
    .settings-header{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid #2f2f2f;}
    .settings-title{font-size:18px;font-weight:600;}
    .settings-close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer;}
    .settings-list{flex:1;overflow-y:auto;padding:0;}
    .settings-item{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid #2f2f2f;cursor:pointer;}
    .settings-item:active{background:#1a1a1a;}
    .settings-info{flex:1;}
    .settings-name{font-size:16px;font-weight:500;margin-bottom:4px;}
    .settings-desc{font-size:13px;color:#b0b0b0;}
    .settings-arrow{color:#b0b0b0;}

    /* Comment Modal */
    .comment-modal{background:#000;width:100%;height:70%;position:fixed;bottom:0;border-radius:20px 20px 0 0;display:none;flex-direction:column;z-index:2000;}
    .comment-header{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid #2f2f2f;}
    .comment-title{font-size:18px;font-weight:600;}
    .comment-close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer;}
    .comment-list{flex:1;overflow-y:auto;padding:16px;}
    .comment-item{padding:12px 0;border-bottom:1px solid #2f2f2f;}
    .comment-user{font-weight:600;font-size:14px;margin-bottom:4px;}
    .comment-text{font-size:14px;color:#e0e0e0;}
    .comment-input-area{display:flex;padding:16px;gap:12px;border-top:1px solid #2f2f2f;}
    .comment-input{flex:1;padding:12px 16px;background:#2f2f2f;border:none;border-radius:20px;color:#fff;font-size:14px;outline:none;}
    .comment-send{background:#ff0050;color:#fff;border:none;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;}

    /* Share Modal */
    .share-modal{background:#000;width:100%;height:50%;position:fixed;bottom:0;border-radius:20px 20px 0 0;display:none;flex-direction:column;z-index:2000;}
    .share-header{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid #2f2f2f;}
    .share-title{font-size:18px;font-weight:600;}
    .share-close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer;}
    .share-options{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;padding:20px;}
    .share-option{display:flex;flex-direction:column;align-items:center;gap:8px;}
    .share-icon{width:60px;height:60px;border-radius:50%;background:#2f2f2f;display:flex;align-items:center;justify-content:center;font-size:24px;}
    .share-label{font-size:12px;text-align:center;}

    /* Loading */
    .spinner{border:3px solid #2f2f2f;border-left:3px solid #ff0050;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;margin:20px auto;}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Success Message */
    .success-message{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#00ff88;color:#000;padding:12px 20px;border-radius:8px;font-weight:600;z-index:3000;display:none;}
  </style>
</head>
<body>

  <!-- ==== AUTH ==== -->
  <div id="auth-page" class="page active">
    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#000;">
      <div style="background:#111;padding:30px;border-radius:16px;width:90%;max-width:380px;text-align:center;">
        <h2 style="margin-bottom:20px;background:linear-gradient(45deg,#ff0050,#ff9000);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">TikTok Social</h2>
        <input type="email" id="auth-email" placeholder="Email" style="width:100%;padding:14px;margin:8px 0;border-radius:8px;border:none;outline:none;background:#2f2f2f;color:#fff;">
        <input type="password" id="auth-pass" placeholder="Password" style="width:100%;padding:14px;margin:8px 0;border-radius:8px;border:none;outline:none;background:#2f2f2f;color:#fff;">
        <button id="login-btn" style="width:100%;padding:14px;margin-top:12px;border:none;border-radius:8px;background:linear-gradient(45deg,#ff0050,#ff9000);color:#fff;font-weight:bold;cursor:pointer;">Log In</button>
        <button id="signup-btn" style="width:100%;padding:14px;margin-top:8px;border:none;border-radius:8px;background:#2f2f2f;color:#fff;font-weight:bold;cursor:pointer;">Create Account</button>
      </div>
    </div>
  </div>

  <!-- ==== MAIN APP ==== -->
  <div id="app" class="page" style="display:none;">

    <!-- Header -->
    <header>
      <div class="logo">TikTok</div>
      <div class="header-icons">
        <i class="fas fa-search header-icon"></i>
        <i class="fas fa-inbox header-icon" id="inbox-btn"></i>
        <span id="msg-badge" class="badge" style="display:none;">0</span>
      </div>
    </header>

    <!-- ==== HOME / FEED ==== -->
    <div id="home-page" class="page active">
      <div class="feed" id="feed">
        <div class="spinner"></div>
      </div>
    </div>

    <!-- ==== FRIENDS ==== -->
    <div id="friends-page" class="page friends-page">
      <div class="friends-header">
        <div class="friends-title">Friends Videos</div>
      </div>
      <div class="friends-videos" id="friends-videos">
        <div class="spinner"></div>
      </div>
    </div>

    <!-- ==== INBOX ==== -->
    <div id="inbox-page" class="page inbox-page">
      <div class="inbox-header">
        <div class="inbox-title">Inbox</div>
        <div class="inbox-tabs">
          <div class="inbox-tab active" data-tab="all">All Users</div>
          <div class="inbox-tab" data-tab="friends">Friends</div>
          <div class="inbox-tab" data-tab="requests">Requests</div>
        </div>
      </div>
      <div class="user-list" id="user-list">
        <div class="spinner"></div>
      </div>
    </div>

    <!-- ==== PROFILE ==== -->
    <div id="profile-page" class="page profile-page">
      <div class="settings-icon" onclick="openSettings()">
        <i class="fas fa-cog"></i>
      </div>
      <div class="profile-header">
        <div class="profile-top">
          <div class="profile-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="profile-stats">
            <div class="stats">
              <div>
                <div id="following-count" class="stat-value">0</div>
                <div class="stat-label">Following</div>
              </div>
              <div>
                <div id="followers-count" class="stat-value">0</div>
                <div class="stat-label">Followers</div>
              </div>
              <div>
                <div id="likes-count" class="stat-value">0</div>
                <div class="stat-label">Likes</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="profile-bio">
          <div id="profile-username" class="username">Loading...</div>
          <div id="profile-handle" style="color:#b0b0b0;font-size:14px;margin:4px 0;">@user</div>
          <div class="bio-text" id="profile-bio-text">+ Add bio Â· ðŸ’· My account is all about...</div>
          <a href="#" class="bio-link">ðŸ’¡ YouTube Channel</a>
          <a href="#" class="bio-link">ðŸ“Œ TikTok Studio</a>
        </div>

        <div class="profile-actions">
          <button id="profile-action-btn" class="edit-btn">Edit profile</button>
          <button class="edit-btn"><i class="fas fa-qrcode"></i></button>
        </div>

        <!-- Drafts Section -->
        <div class="drafts-section">
          <div class="drafts-header">
            <div class="drafts-title">Drafts</div>
            <div class="drafts-stats">
              <div class="draft-stat">
                <div id="drafts-count" class="draft-value">0</div>
                <div class="draft-label">Drafts</div>
              </div>
              <div class="draft-stat">
                <div class="draft-value">0MB</div>
                <div class="draft-label">0% â€¢ 0</div>
              </div>
            </div>
          </div>
          <div id="drafts-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
            <div style="background:linear-gradient(45deg,#ff0050,#ff9000);aspect-ratio:9/16;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;" onclick="showModal('upload-modal')">
              <i class="fas fa-plus"></i>
            </div>
          </div>
        </div>
      </div>
      
      <div class="profile-videos" id="profile-videos">
        <div class="spinner"></div>
      </div>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
      <div class="nav-item active" data-page="home">
        <i class="fas fa-home nav-icon"></i>
        <span>Home</span>
      </div>
      <div class="nav-item" data-page="friends">
        <i class="fas fa-user-friends nav-icon"></i>
        <span>Friends</span>
      </div>
      <div class="nav-item" id="upload-nav">
        <div style="background:linear-gradient(45deg,#ff0050,#ff9000);width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-top:-20px;">
          <i class="fas fa-plus nav-icon" style="color:#fff;margin:0;font-size:20px;"></i>
        </div>
      </div>
      <div class="nav-item" data-page="inbox">
        <i class="fas fa-inbox nav-icon"></i>
        <span>Inbox</span>
      </div>
      <div class="nav-item" data-page="profile">
        <i class="fas fa-user nav-icon"></i>
        <span>Profile</span>
      </div>
    </div>
  </div>

  <!-- ==== CHAT PAGE ==== -->
  <div id="chat-page" class="chat-page">
    <div class="chat-header">
      <button class="chat-back" onclick="closeChat()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="chat-user">
        <div class="chat-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="chat-info">
          <div class="chat-name" id="chat-user-name">User Name</div>
          <div class="chat-status" id="chat-user-status">Online</div>
        </div>
      </div>
    </div>
    <div class="chat-messages" id="chat-messages">
      <div class="spinner"></div>
    </div>
    <div class="chat-input">
      <input type="text" id="chat-input" placeholder="Type a message...">
      <button class="chat-send" onclick="sendMessage()">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- Upload Modal -->
  <div id="upload-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Create</div>
      </div>
      <div class="modal-options">
        <div class="modal-option" onclick="openGalleryUpload()">
          <div class="modal-icon">
            <i class="fas fa-photo-video"></i>
          </div>
          <div class="modal-label">Gallery</div>
        </div>
        <div class="modal-option" onclick="startCamera()">
          <div class="modal-icon">
            <i class="fas fa-camera"></i>
          </div>
          <div class="modal-label">Camera</div>
        </div>
        <div class="modal-option">
          <div class="modal-icon">
            <i class="fas fa-edit"></i>
          </div>
          <div class="modal-label">Template</div>
        </div>
        <div class="modal-option" onclick="goLive()">
          <div class="modal-icon">
            <i class="fas fa-broadcast-tower"></i>
          </div>
          <div class="modal-label">Go Live</div>
        </div>
        <div class="modal-option" onclick="createDraft()">
          <div class="modal-icon">
            <i class="fas fa-file"></i>
          </div>
          <div class="modal-label">Draft</div>
        </div>
        <div class="modal-option">
          <div class="modal-icon">
            <i class="fas fa-music"></i>
          </div>
          <div class="modal-label">Add Sound</div>
        </div>
      </div>
      <button style="width:100%;padding:16px;margin-top:20px;background:#2f2f2f;color:#fff;border:none;border-radius:12px;font-size:16px;cursor:pointer;" onclick="hideModal()">Cancel</button>
    </div>
  </div>

  <!-- Gallery Upload Modal -->
  <div id="gallery-modal" class="modal">
    <div class="gallery-modal">
      <div class="gallery-header">
        <div class="gallery-title">Upload from Gallery</div>
        <button class="gallery-close" onclick="hideModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="gallery-content">
        <input type="file" id="file-input" accept="image/*,video/*" style="display:none;">
        <div class="upload-area" onclick="document.getElementById('file-input').click()">
          <div class="upload-icon">
            <i class="fas fa-cloud-upload-alt"></i>
          </div>
          <div class="upload-text">Select photo or video</div>
          <div class="upload-subtext">Supported formats: MP4, MOV, JPG, PNG</div>
        </div>
        <img id="upload-preview" class="upload-preview" alt="Preview">
        <input type="text" id="caption-input" class="caption-input" placeholder="Write a caption...">
        <div class="upload-actions">
          <button class="upload-action upload-cancel" onclick="hideModal()">Cancel</button>
          <button class="upload-action upload-post" onclick="uploadMedia()">Post</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="settings-modal">
    <div class="settings-header">
      <div class="settings-title">Settings</div>
      <button class="settings-close" onclick="closeSettings()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="settings-list">
      <div class="settings-item" onclick="editProfile()">
        <div class="settings-info">
          <div class="settings-name">Edit Profile</div>
          <div class="settings-desc">Change your username, bio, and profile picture</div>
        </div>
        <div class="settings-arrow">
          <i class="fas fa-chevron-right"></i>
        </div>
      </div>
      <div class="settings-item" onclick="privacySettings()">
        <div class="settings-info">
          <div class="settings-name">Privacy</div>
          <div class="settings-desc">Manage your account privacy and security</div>
        </div>
        <div class="settings-arrow">
          <i class="fas fa-chevron-right"></i>
        </div>
      </div>
      <div class="settings-item" onclick="notificationSettings()">
        <div class="settings-info">
          <div class="settings-name">Notifications</div>
          <div class="settings-desc">Control your notification preferences</div>
        </div>
        <div class="settings-arrow">
          <i class="fas fa-chevron-right"></i>
        </div>
      </div>
      <div class="settings-item" onclick="contentPreferences()">
        <div class="settings-info">
          <div class="settings-name">Content Preferences</div>
          <div class="settings-desc">Manage your content and feed preferences</div>
        </div>
        <div class="settings-arrow">
          <i class="fas fa-chevron-right"></i>
        </div>
      </div>
      <div class="settings-item" onclick="helpCenter()">
        <div class="settings-info">
          <div class="settings-name">Help Center</div>
          <div class="settings-desc">Get help and support</div>
        </div>
        <div class="settings-arrow">
          <i class="fas fa-chevron-right"></i>
        </div>
      </div>
      <div class="settings-item" onclick="aboutApp()">
        <div class="settings-info">
          <div class="settings-name">About</div>
          <div class="settings-desc">App version and information</div>
        </div>
        <div class="settings-arrow">
          <i class="fas fa-chevron-right"></i>
        </div>
      </div>
      <div class="settings-item" onclick="logout()" style="color:#ff0050;">
        <div class="settings-info">
          <div class="settings-name">Log Out</div>
          <div class="settings-desc">Sign out of your account</div>
        </div>
        <div class="settings-arrow">
          <i class="fas fa-chevron-right"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Comment Modal -->
  <div id="comment-modal" class="comment-modal">
    <div class="comment-header">
      <div class="comment-title">Comments</div>
      <button class="comment-close" onclick="closeCommentModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="comment-list" id="comment-list">
      <div class="spinner"></div>
    </div>
    <div class="comment-input-area">
      <input type="text" id="comment-input" class="comment-input" placeholder="Add a comment...">
      <button class="comment-send" onclick="addComment()">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- Share Modal -->
  <div id="share-modal" class="share-modal">
    <div class="share-header">
      <div class="share-title">Share</div>
      <button class="share-close" onclick="closeShareModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="share-options">
      <div class="share-option" onclick="shareTo('facebook')">
        <div class="share-icon" style="background:#1877f2;">
          <i class="fab fa-facebook-f"></i>
        </div>
        <div class="share-label">Facebook</div>
      </div>
      <div class="share-option" onclick="shareTo('whatsapp')">
        <div class="share-icon" style="background:#25d366;">
          <i class="fab fa-whatsapp"></i>
        </div>
        <div class="share-label">WhatsApp</div>
      </div>
      <div class="share-option" onclick="shareTo('instagram')">
        <div class="share-icon" style="background:#e4405f;">
          <i class="fab fa-instagram"></i>
        </div>
        <div class="share-label">Instagram</div>
      </div>
      <div class="share-option" onclick="shareTo('twitter')">
        <div class="share-icon" style="background:#1da1f2;">
          <i class="fab fa-twitter"></i>
        </div>
        <div class="share-label">Twitter</div>
      </div>
      <div class="share-option" onclick="copyLink()">
        <div class="share-icon">
          <i class="fas fa-link"></i>
        </div>
        <div class="share-label">Copy Link</div>
      </div>
      <div class="share-option" onclick="saveVideo()">
        <div class="share-icon">
          <i class="fas fa-download"></i>
        </div>
        <div class="share-label">Save Video</div>
      </div>
      <div class="share-option" onclick="shareTo('message')">
        <div class="share-icon">
          <i class="fas fa-comment"></i>
        </div>
        <div class="share-label">Message</div>
      </div>
      <div class="share-option" onclick="shareTo('email')">
        <div class="share-icon">
          <i class="fas fa-envelope"></i>
        </div>
        <div class="share-label">Email</div>
      </div>
    </div>
  </div>

  <!-- Success Message -->
  <div id="success-message" class="success-message">
    <i class="fas fa-check-circle"></i> Post uploaded successfully!
  </div>

  <!-- ==== Firebase ==== -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // ---------- Firebase Config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDYwtq05q9qXhrNVJ4I-I-LuD1dpp2Suk8",
      authDomain: "massage-8c66f.firebaseapp.com",
      databaseURL: "https://massage-8c66f-default-rtdb.firebaseio.com",
      projectId: "massage-8c66f",
      storageBucket: "massage-8c66f.firebasestorage.app",
      messagingSenderId: "557008720018",
      appId: "1:557008720018:web:22055db26bbfb2bab3d64b"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ---------- Global Variables ----------
    let currentUser = null;
    let currentChatUser = null;
    let currentProfileUser = null;
    let currentVideoId = null;
    let selectedFile = null;
    const pages = {
      auth: document.getElementById('auth-page'),
      home: document.getElementById('home-page'),
      friends: document.getElementById('friends-page'),
      profile: document.getElementById('profile-page'),
      inbox: document.getElementById('inbox-page')
    };

    // ---------- Auth System ----------
    document.getElementById('login-btn').onclick = () => login();
    document.getElementById('signup-btn').onclick = () => signup();

    function login() {
      const email = document.getElementById('auth-email').value.trim();
      const pass  = document.getElementById('auth-pass').value;
      if (!email || !pass) return alert('Fill all fields');
      auth.signInWithEmailAndPassword(email, pass)
        .then(cred => afterAuth(cred.user))
        .catch(err => alert(err.message));
    }
    
    function signup() {
      const email = document.getElementById('auth-email').value.trim();
      const pass  = document.getElementById('auth-pass').value;
      const username = prompt('Choose a username:');
      if (!email || !pass || !username) return alert('All fields required');
      auth.createUserWithEmailAndPassword(email, pass)
        .then(cred => {
          return db.ref('users/' + cred.user.uid).set({
            username: username,
            email: email,
            following: {},
            followers: {},
            likes: 0,
            friends: {},
            createdAt: Date.now()
          }).then(() => afterAuth(cred.user));
        })
        .catch(err => alert(err.message));
    }
    
    function afterAuth(user) {
      currentUser = user;
      pages.auth.classList.remove('active');
      document.getElementById('app').style.display = 'flex';
      showPage('home');
      loadGlobalFeed();
      loadInboxUsers();
      loadProfile(user.uid);
      updateMessageBadge();
      
      // Create demo users if they don't exist
      createDemoUsers();
    }
    
    auth.onAuthStateChanged(user => {
      if (!user) {
        document.getElementById('app').style.display = 'none';
        pages.auth.classList.add('active');
      } else {
        currentUser = user;
      }
    });

    // ---------- Demo Users Creation ----------
    function createDemoUsers() {
      const demoUsers = [
        {
          uid: 'demo_user_1',
          username: 'sanay_xettri',
          email: 'sanay@demo.com',
          following: {},
          followers: { [currentUser.uid]: true },
          likes: 7656,
          friends: { [currentUser.uid]: true },
          createdAt: Date.now()
        },
        {
          uid: 'demo_user_2',
          username: 'rawatpharmacy',
          email: 'pharmacy@demo.com',
          following: {},
          followers: {},
          likes: 12500,
          friends: {},
          createdAt: Date.now()
        },
        {
          uid: 'demo_user_3',
          username: 'stem_explore',
          email: 'stem@demo.com',
          following: {},
          followers: {},
          likes: 8900,
          friends: {},
          createdAt: Date.now()
        }
      ];

      demoUsers.forEach(demoUser => {
        db.ref('users/' + demoUser.uid).once('value').then(snap => {
          if (!snap.exists()) {
            db.ref('users/' + demoUser.uid).set(demoUser);
          }
        });
      });

      // Create demo videos
      createDemoVideos();
    }

    // ---------- Navigation ----------
    document.querySelectorAll('.nav-item').forEach(el => {
      if (el.id !== 'upload-nav') {
        el.addEventListener('click', () => {
          const p = el.dataset.page;
          showPage(p);
          document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
          el.classList.add('active');
          
          if (p === 'inbox') {
            loadInboxUsers();
          } else if (p === 'friends') {
            loadFriendsPage();
          } else if (p === 'profile') {
            loadProfile(currentUser.uid);
          }
        });
      }
    });

    // Upload button
    document.getElementById('upload-nav').onclick = () => {
      showModal('upload-modal');
    };

    function showPage(name) {
      Object.values(pages).forEach(p=>p.classList.remove('active'));
      pages[name].classList.add('active');
    }

    // ---------- Modal Functions ----------
    function showModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }

    function hideModal() {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
      });
      // Reset file input
      document.getElementById('file-input').value = '';
      document.getElementById('upload-preview').style.display = 'none';
      document.getElementById('caption-input').value = '';
      selectedFile = null;
    }

    function openGalleryUpload() {
      hideModal();
      showModal('gallery-modal');
    }

    // ---------- Settings Functions ----------
    function openSettings() {
      showModal('settings-modal');
    }

    function closeSettings() {
      document.getElementById('settings-modal').style.display = 'none';
    }

    function editProfile() {
      closeSettings();
      const newUsername = prompt('Enter new username:', currentUser.displayName || currentUser.email.split('@')[0]);
      if (newUsername) {
        db.ref('users/' + currentUser.uid + '/username').set(newUsername);
        showSuccess('Profile updated successfully!');
      }
    }

    function privacySettings() {
      closeSettings();
      alert('Privacy settings would open here');
    }

    function notificationSettings() {
      closeSettings();
      alert('Notification settings would open here');
    }

    function contentPreferences() {
      closeSettings();
      alert('Content preferences would open here');
    }

    function helpCenter() {
      closeSettings();
      alert('Help center would open here');
    }

    function aboutApp() {
      closeSettings();
      alert('TikTok Social App v1.0\nBuilt with Firebase Real-time Database');
    }

    function logout() {
      if (confirm('Are you sure you want to log out?')) {
        auth.signOut().then(() => {
          showPage('auth');
          document.getElementById('app').style.display = 'none';
          document.getElementById('auth-email').value = '';
          document.getElementById('auth-pass').value = '';
        });
      }
    }

    // ---------- Success Message ----------
    function showSuccess(message) {
      const successMsg = document.getElementById('success-message');
      successMsg.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
      successMsg.style.display = 'block';
      setTimeout(() => {
        successMsg.style.display = 'none';
      }, 3000);
    }

    // ---------- File Upload Handling ----------
    document.getElementById('file-input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        selectedFile = file;
        const preview = document.getElementById('upload-preview');
        
        if (file.type.startsWith('image/')) {
          preview.src = URL.createObjectURL(file);
          preview.style.display = 'block';
        } else if (file.type.startsWith('video/')) {
          // For videos, we'll show a thumbnail or just the file name
          preview.src = 'https://cdn-icons-png.flaticon.com/512/1256/1256650.png';
          preview.style.display = 'block';
        }
      }
    });

    function uploadMedia() {
      if (!selectedFile) {
        alert('Please select a file first');
        return;
      }

      const caption = document.getElementById('caption-input').value.trim();
      
      // In a real app, you would upload to Firebase Storage
      // For demo purposes, we'll use a placeholder URL
      let fileUrl;
      if (selectedFile.type.startsWith('video/')) {
        fileUrl = 'https://assets.mixkit.co/videos/preview/mixkit-group-of-friends-partying-happily-4640-large.mp4';
      } else {
        fileUrl = 'https://picsum.photos/400/700';
      }
      
      // Upload to Firebase Database
      db.ref('videos').push({
        uid: currentUser.uid,
        username: currentUser.displayName || currentUser.email.split('@')[0],
        url: fileUrl,
        caption: caption,
        likedBy: {},
        comments: {},
        shares: 0,
        timestamp: Date.now(),
        isDraft: false,
        type: selectedFile.type.startsWith('video/') ? 'video' : 'image'
      }).then(() => {
        showSuccess('Post uploaded successfully!');
        hideModal();
        loadGlobalFeed();
      });
    }

    // ---------- Video Feed ----------
    function loadGlobalFeed() {
      const feedContainer = document.getElementById('feed');
      feedContainer.innerHTML = '<div class="spinner"></div>';
      
      db.ref('videos').orderByChild('timestamp').limitToLast(20).on('value', (snapshot) => {
        const videos = snapshot.val() || {};
        renderVideos(videos, feedContainer);
      });
    }

    function renderVideos(videosObj, container) {
      if (!Object.keys(videosObj).length) {
        container.innerHTML = '<div style="color:#aaa;text-align:center;padding:30px;">No videos yet. Upload the first video!</div>';
        return;
      }
      
      container.innerHTML = '';
      Object.entries(videosObj).reverse().forEach(([videoId, video]) => {
        if (video.isDraft) return;
        
        const card = document.createElement('div');
        card.className = 'video-card';
        card.innerHTML = `
          <video loop playsinline>
            <source src="${video.url}" type="video/mp4">
          </video>
          <div class="video-overlay">
            <div class="user-info" onclick="viewProfile('${video.uid}')">
              <div class="user-avatar">
                <i class="fas fa-user"></i>
              </div>
              <div class="user-details">
                <div class="username">@${video.username}</div>
                <div class="caption">${video.caption || ''}</div>
              </div>
            </div>
          </div>
          <div class="actions">
            <div class="action-btn like-btn ${video.likedBy && video.likedBy[currentUser.uid] ? 'liked' : ''}" onclick="toggleLike('${videoId}', this)">
              <i class="fas fa-heart"></i>
              <div class="action-count">${Object.keys(video.likedBy || {}).length}</div>
            </div>
            <div class="action-btn" onclick="openComments('${videoId}')">
              <i class="fas fa-comment"></i>
              <div class="action-count">${Object.keys(video.comments || {}).length}</div>
            </div>
            <div class="action-btn" onclick="toggleFavorite('${videoId}', this)">
              <i class="fas fa-star"></i>
              <div class="action-count">Favorite</div>
            </div>
            <div class="action-btn" onclick="openShare('${videoId}')">
              <i class="fas fa-share"></i>
              <div class="action-count">${video.shares || 0}</div>
            </div>
          </div>
        `;
        
        const videoEl = card.querySelector('video');
        
        // Auto-play when visible
        const observer = new IntersectionObserver(entries => {
          entries.forEach(e => {
            if (e.isIntersecting) {
              videoEl.play().catch(() => {});
            } else {
              videoEl.pause();
            }
          });
        }, {threshold: 0.7});
        observer.observe(card);
        
        container.appendChild(card);
      });
    }

    // ---------- Like System ----------
    function toggleLike(videoId, likeBtn) {
      const videoRef = db.ref('videos/' + videoId);
      
      videoRef.once('value').then(snapshot => {
        const video = snapshot.val();
        const likedBy = video.likedBy || {};
        const isLiked = !!likedBy[currentUser.uid];
        
        const updates = {};
        if (isLiked) {
          updates[`videos/${videoId}/likedBy/${currentUser.uid}`] = null;
          updates[`users/${video.uid}/likes`] = firebase.database.ServerValue.increment(-1);
        } else {
          updates[`videos/${videoId}/likedBy/${currentUser.uid}`] = true;
          updates[`users/${video.uid}/likes`] = firebase.database.ServerValue.increment(1);
        }
        
        db.ref().update(updates);
      });
    }

    // ---------- Comment System ----------
    function openComments(videoId) {
      currentVideoId = videoId;
      document.getElementById('comment-modal').style.display = 'flex';
      loadComments(videoId);
    }

    function closeCommentModal() {
      document.getElementById('comment-modal').style.display = 'none';
    }

    function loadComments(videoId) {
      const commentList = document.getElementById('comment-list');
      commentList.innerHTML = '<div class="spinner"></div>';
      
      db.ref('videos/' + videoId + '/comments').orderByChild('timestamp').on('value', (snapshot) => {
        const comments = snapshot.val() || {};
        commentList.innerHTML = '';
        
        if (Object.keys(comments).length === 0) {
          commentList.innerHTML = '<div style="color:#aaa;text-align:center;padding:30px;">No comments yet</div>';
          return;
        }
        
        Object.entries(comments).reverse().forEach(([commentId, comment]) => {
          const commentEl = document.createElement('div');
          commentEl.className = 'comment-item';
          commentEl.innerHTML = `
            <div class="comment-user">@${comment.username}</div>
            <div class="comment-text">${comment.text}</div>
          `;
          commentList.appendChild(commentEl);
        });
      });
    }

    function addComment() {
      const commentInput = document.getElementById('comment-input');
      const text = commentInput.value.trim();
      
      if (text && currentVideoId) {
        db.ref('videos/' + currentVideoId + '/comments').push({
          uid: currentUser.uid,
          username: currentUser.displayName || currentUser.email.split('@')[0],
          text: text,
          timestamp: Date.now()
        });
        
        commentInput.value = '';
      }
    }

    // ---------- Share System ----------
    function openShare(videoId) {
      currentVideoId = videoId;
      document.getElementById('share-modal').style.display = 'flex';
    }

    function closeShareModal() {
      document.getElementById('share-modal').style.display = 'none';
    }

    function shareTo(platform) {
      // Increment share count
      db.ref('videos/' + currentVideoId + '/shares').transaction(currentShares => {
        return (currentShares || 0) + 1;
      });
      
      alert(`Shared to ${platform}!`);
      closeShareModal();
    }

    function copyLink() {
      navigator.clipboard.writeText(window.location.href);
      alert('Link copied to clipboard!');
      closeShareModal();
    }

    function saveVideo() {
      alert('Video saved to your device!');
      closeShareModal();
    }

    // ---------- Favorite System ----------
    function toggleFavorite(videoId, favoriteBtn) {
      favoriteBtn.classList.toggle('liked');
      if (favoriteBtn.classList.contains('liked')) {
        showSuccess('Added to favorites!');
      } else {
        showSuccess('Removed from favorites!');
      }
    }

    // ---------- Follow System ----------
    function toggleFollow(targetUid, followBtn) {
      const updates = {};
      const userRef = db.ref('users/' + currentUser.uid);
      
      userRef.once('value').then(snapshot => {
        const user = snapshot.val();
        const isFollowing = !!user.following && !!user.following[targetUid];
        
        if (isFollowing) {
          // Unfollow
          updates[`users/${currentUser.uid}/following/${targetUid}`] = null;
          updates[`users/${targetUid}/followers/${currentUser.uid}`] = null;
          
          // Remove from friends if exists
          updates[`users/${currentUser.uid}/friends/${targetUid}`] = null;
          updates[`users/${targetUid}/friends/${currentUser.uid}`] = null;
        } else {
          // Follow
          updates[`users/${currentUser.uid}/following/${targetUid}`] = true;
          updates[`users/${targetUid}/followers/${currentUser.uid}`] = true;
          
          // Send friend request
          updates[`friendRequests/${targetUid}/${currentUser.uid}`] = {
            from: currentUser.uid,
            username: user.username,
            timestamp: Date.now()
          };
        }
        
        db.ref().update(updates).then(() => {
          updateMessageBadge();
          if (currentProfileUser) {
            loadProfile(currentProfileUser);
          }
        });
      });
    }

    // ---------- Friends Videos ----------
    function loadFriendsPage() {
      const friendsVideos = document.getElementById('friends-videos');
      friendsVideos.innerHTML = '<div class="spinner"></div>';
      
      // Get friends list
      db.ref('users/' + currentUser.uid + '/friends').once('value').then(snapshot => {
        const friends = snapshot.val() || {};
        const friendIds = Object.keys(friends);
        
        if (friendIds.length === 0) {
          friendsVideos.innerHTML = '<div style="color:#aaa;text-align:center;padding:30px;grid-column:1/-1;">No friends yet. Follow people to see their videos here.</div>';
          return;
        }
        
        // Load videos from friends
        db.ref('videos').orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
          const allVideos = snapshot.val() || {};
          friendsVideos.innerHTML = '';
          
          Object.entries(allVideos).reverse().forEach(([videoId, video]) => {
            if (friendIds.includes(video.uid) && !video.isDraft) {
              const videoEl = document.createElement('div');
              videoEl.className = 'friend-video';
              videoEl.innerHTML = `
                <video loop muted>
                  <source src="${video.url}" type="video/mp4">
                </video>
                <div class="friend-video-overlay">
                  <i class="fas fa-heart"></i> ${Object.keys(video.likedBy || {}).length}
                </div>
              `;
              videoEl.onclick = () => playFriendVideo(video);
              friendsVideos.appendChild(videoEl);
            }
          });
        });
      });
    }

    function playFriendVideo(video) {
      // In a real app, this would open the video in full screen
      alert(`Playing video from @${video.username}`);
    }

    // ---------- Inbox Users ----------
    function loadInboxUsers() {
      const userList = document.getElementById('user-list');
      userList.innerHTML = '<div class="spinner"></div>';
      
      const activeTab = document.querySelector('.inbox-tab.active').dataset.tab;
      
      if (activeTab === 'all') {
        // Load all users except current user
        db.ref('users').on('value', (snapshot) => {
          const users = snapshot.val() || {};
          const filteredUsers = {};
          Object.keys(users).forEach(uid => {
            if (uid !== currentUser.uid) {
              filteredUsers[uid] = users[uid];
            }
          });
          renderUsers(filteredUsers, userList);
        });
      } else if (activeTab === 'friends') {
        // Load friends
        db.ref('users/' + currentUser.uid + '/friends').on('value', (snapshot) => {
          const friends = snapshot.val() || {};
          const friendIds = Object.keys(friends);
          
          if (friendIds.length === 0) {
            userList.innerHTML = '<div style="color:#aaa;text-align:center;padding:30px;">No friends yet</div>';
            return;
          }
          
          db.ref('users').once('value').then(snapshot => {
            const allUsers = snapshot.val() || {};
            const friendUsers = {};
            
            friendIds.forEach(fid => {
              if (allUsers[fid] && fid !== currentUser.uid) {
                friendUsers[fid] = allUsers[fid];
              }
            });
            
            renderUsers(friendUsers, userList);
          });
        });
      } else if (activeTab === 'requests') {
        // Load friend requests
        db.ref('friendRequests/' + currentUser.uid).on('value', (snapshot) => {
          const requests = snapshot.val() || {};
          
          if (Object.keys(requests).length === 0) {
            userList.innerHTML = '<div style="color:#aaa;text-align:center;padding:30px;">No friend requests</div>';
            return;
          }
          
          const requestUserIds = Object.keys(requests);
          db.ref('users').once('value').then(snapshot => {
            const allUsers = snapshot.val() || {};
            const requestUsers = {};
            
            requestUserIds.forEach(uid => {
              if (allUsers[uid]) {
                requestUsers[uid] = allUsers[uid];
              }
            });
            
            renderRequestUsers(requestUsers, requests, userList);
          });
        });
      }
    }

    function renderUsers(users, container) {
      container.innerHTML = '';
      
      Object.entries(users).forEach(([uid, user]) => {
        const isFollowing = currentUser && user.followers && user.followers[currentUser.uid];
        const isFriend = currentUser && user.friends && user.friends[currentUser.uid];
        
        const userEl = document.createElement('div');
        userEl.className = 'user-item';
        userEl.innerHTML = `
          <div class="user-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="user-details" onclick="openChat('${uid}', '${user.username}')">
            <div class="user-name">${user.username}</div>
            <div class="user-status">@${user.username}</div>
          </div>
          <div class="user-stats">
            <div class="followers-count">${Object.keys(user.followers || {}).length} followers</div>
            ${!isFriend ? `
              <button class="follow-btn-small ${isFollowing ? 'following' : ''}" onclick="toggleFollow('${uid}', this)">
                ${isFollowing ? 'Following' : 'Follow'}
              </button>
            ` : `
              <button class="follow-btn-small" style="background:#2f2f2f;">Friends</button>
            `}
          </div>
        `;
        container.appendChild(userEl);
      });
    }

    function renderRequestUsers(users, requests, container) {
      container.innerHTML = '';
      
      Object.entries(users).forEach(([uid, user]) => {
        const request = requests[uid];
        
        const userEl = document.createElement('div');
        userEl.className = 'user-item';
        userEl.innerHTML = `
          <div class="user-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="user-details">
            <div class="user-name">${user.username}</div>
            <div class="user-status">Wants to be friends</div>
          </div>
          <div class="user-stats">
            <button class="follow-btn-small" onclick="acceptFriendRequest('${uid}')">Accept</button>
            <button class="follow-btn-small" onclick="declineFriendRequest('${uid}')" style="background:#2f2f2f;margin-left:8px;">Delete</button>
          </div>
        `;
        container.appendChild(userEl);
      });
    }

    function acceptFriendRequest(fromUid) {
      const updates = {};
      updates[`friendRequests/${currentUser.uid}/${fromUid}`] = null;
      updates[`users/${currentUser.uid}/friends/${fromUid}`] = true;
      updates[`users/${fromUid}/friends/${currentUser.uid}`] = true;
      
      db.ref().update(updates).then(() => {
        loadInboxUsers();
        updateMessageBadge();
      });
    }

    function declineFriendRequest(fromUid) {
      db.ref(`friendRequests/${currentUser.uid}/${fromUid}`).remove().then(() => {
        loadInboxUsers();
        updateMessageBadge();
      });
    }

    // ---------- Chat System ----------
    function openChat(userId, userName) {
      currentChatUser = { id: userId, name: userName };
      document.getElementById('chat-user-name').textContent = userName;
      document.getElementById('chat-page').style.display = 'flex';
      document.getElementById('app').style.display = 'none';
      
      loadChatMessages(userId);
    }

    function closeChat() {
      document.getElementById('chat-page').style.display = 'none';
      document.getElementById('app').style.display = 'flex';
      showPage('inbox');
    }

    function loadChatMessages(userId) {
      const messagesContainer = document.getElementById('chat-messages');
      messagesContainer.innerHTML = '<div class="spinner"></div>';
      
      const chatId = [currentUser.uid, userId].sort().join('_');
      
      db.ref('chats/' + chatId).orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
        const messages = snapshot.val() || {};
        messagesContainer.innerHTML = '';
        
        // Convert to array and sort by timestamp
        const messagesArray = Object.entries(messages).map(([msgId, message]) => ({
          id: msgId,
          ...message
        })).sort((a, b) => a.timestamp - b.timestamp);
        
        messagesArray.forEach(message => {
          const messageEl = document.createElement('div');
          messageEl.className = `message ${message.sender === currentUser.uid ? 'message-sent' : 'message-received'}`;
          messageEl.textContent = message.text;
          messagesContainer.appendChild(messageEl);
        });
        
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });
    }

    function sendMessage() {
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      
      if (text && currentChatUser) {
        const chatId = [currentUser.uid, currentChatUser.id].sort().join('_');
        
        db.ref('chats/' + chatId).push({
          sender: currentUser.uid,
          text: text,
          timestamp: Date.now()
        });
        
        input.value = '';
      }
    }

    // ---------- Profile System ----------
    function loadProfile(userId) {
      currentProfileUser = userId;
      
      db.ref('users/' + userId).on('value', (snapshot) => {
        const user = snapshot.val();
        if (!user) return;
        
        document.getElementById('profile-username').textContent = user.username;
        document.getElementById('profile-handle').textContent = '@' + user.username;
        document.getElementById('following-count').textContent = Object.keys(user.following || {}).length;
        document.getElementById('followers-count').textContent = Object.keys(user.followers || {}).length;
        document.getElementById('likes-count').textContent = user.likes || 0;
        
        const actionBtn = document.getElementById('profile-action-btn');
        if (userId === currentUser.uid) {
          actionBtn.textContent = 'Edit profile';
          actionBtn.onclick = () => editProfile();
          actionBtn.className = 'edit-btn';
        } else {
          const isFollowing = user.followers && user.followers[currentUser.uid];
          actionBtn.textContent = isFollowing ? 'Following' : 'Follow';
          actionBtn.className = isFollowing ? 'follow-btn following' : 'follow-btn';
          actionBtn.onclick = () => toggleFollow(userId, actionBtn);
        }
        
        loadProfileVideos(userId);
        loadDrafts(userId);
      });
    }

    function loadProfileVideos(userId) {
      const profileVideos = document.getElementById('profile-videos');
      profileVideos.innerHTML = '<div class="spinner"></div>';
      
      db.ref('videos').orderByChild('uid').equalTo(userId).on('value', (snapshot) => {
        const videos = snapshot.val() || {};
        profileVideos.innerHTML = '';
        
        Object.entries(videos).reverse().forEach(([videoId, video]) => {
          if (video.isDraft && userId !== currentUser.uid) return;
          
          const videoEl = document.createElement('div');
          videoEl.className = 'profile-video';
          
          if (video.isDraft) {
            videoEl.innerHTML = `
              <video loop muted>
                <source src="${video.url}" type="video/mp4">
              </video>
              <div class="video-stats">
                <i class="fas fa-edit"></i> Draft
              </div>
              <div style="position:absolute;top:8px;right:8px;display:flex;gap:4px;">
                <button onclick="postDraft('${videoId}')" style="background:#ff0050;color:#fff;border:none;border-radius:4px;padding:4px 8px;font-size:10px;">Post</button>
                <button onclick="deleteDraft('${videoId}')" style="background:#2f2f2f;color:#fff;border:none;border-radius:4px;padding:4px 8px;font-size:10px;">Delete</button>
              </div>
            `;
          } else {
            videoEl.innerHTML = `
              <video loop muted>
                <source src="${video.url}" type="video/mp4">
              </video>
              <div class="video-stats">
                <i class="fas fa-heart"></i> ${Object.keys(video.likedBy || {}).length}
              </div>
            `;
          }
          
          profileVideos.appendChild(videoEl);
        });
      });
    }

    function loadDrafts(userId) {
      if (userId !== currentUser.uid) return;
      
      db.ref('videos').orderByChild('uid').equalTo(userId).once('value').then((snapshot) => {
        const videos = snapshot.val() || {};
        let draftCount = 0;
        
        Object.values(videos).forEach(video => {
          if (video.isDraft) draftCount++;
        });
        
        document.getElementById('drafts-count').textContent = draftCount;
      });
    }

    function postDraft(videoId) {
      db.ref('videos/' + videoId + '/isDraft').set(false).then(() => {
        showSuccess('Draft posted successfully!');
        loadProfile(currentUser.uid);
      });
    }

    function deleteDraft(videoId) {
      if (confirm('Are you sure you want to delete this draft?')) {
        db.ref('videos/' + videoId).remove().then(() => {
          loadProfile(currentUser.uid);
        });
      }
    }

    // ---------- Demo Videos Creation ----------
    function createDemoVideos() {
      const demoVideos = [
        {
          uid: 'demo_user_1',
          username: 'sanay_xettri',
          url: 'https://assets.mixkit.co/videos/preview/mixkit-group-of-friends-partying-happily-4640-large.mp4',
          caption: 'Best moments with friends! ðŸŽ‰ #friends #fun',
          likedBy: { [currentUser.uid]: true },
          comments: {
            comment1: {
              uid: currentUser.uid,
              username: currentUser.displayName || currentUser.email.split('@')[0],
              text: 'Looks amazing!',
              timestamp: Date.now() - 3600000
            }
          },
          shares: 5,
          timestamp: Date.now() - 86400000,
          isDraft: false,
          type: 'video'
        },
        {
          uid: 'demo_user_2',
          username: 'rawatpharmacy',
          url: 'https://picsum.photos/400/700',
          caption: 'New products available! ðŸ’Š #pharmacy #health',
          likedBy: {},
          comments: {},
          shares: 2,
          timestamp: Date.now() - 172800000,
          isDraft: false,
          type: 'image'
        },
        {
          uid: 'demo_user_3',
          username: 'stem_explore',
          url: 'https://assets.mixkit.co/videos/preview/mixkit-scientist-observing-chemical-reaction-46457-large.mp4',
          caption: 'Science is amazing! ðŸ”¬ #science #education',
          likedBy: {},
          comments: {},
          shares: 8,
          timestamp: Date.now() - 259200000,
          isDraft: false,
          type: 'video'
        }
      ];

      // Check if demo videos already exist
      db.ref('videos').once('value').then(snapshot => {
        const existingVideos = snapshot.val() || {};
        const hasDemoVideos = Object.values(existingVideos).some(video => 
          video.uid && video.uid.startsWith('demo_user_')
        );

        if (!hasDemoVideos) {
          demoVideos.forEach(video => {
            db.ref('videos').push(video);
          });
        }
      });
    }

    // ---------- View Profile ----------
    function viewProfile(userId) {
      if (userId === currentUser.uid) {
        showPage('profile');
        loadProfile(currentUser.uid);
      } else {
        // In a real app, this would navigate to the user's profile
        loadProfile(userId);
        showPage('profile');
      }
    }

    // ---------- Update Message Badge ----------
    function updateMessageBadge() {
      db.ref('friendRequests/' + currentUser.uid).once('value').then(snapshot => {
        const requests = snapshot.val() || {};
        const requestCount = Object.keys(requests).length;
        
        const badge = document.getElementById('msg-badge');
        if (requestCount > 0) {
          badge.textContent = requestCount;
          badge.style.display = 'block';
        } else {
          badge.style.display = 'none';
        }
      });
    }

    // ---------- Inbox Tab Switching ----------
    document.querySelectorAll('.inbox-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.inbox-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        loadInboxUsers();
      });
    });

    // ---------- Additional Features ----------
    function startCamera() {
      hideModal();
      alert('Camera would open here');
    }

    function goLive() {
      hideModal();
      alert('Live streaming would start here');
    }

    function createDraft() {
      hideModal();
      // Create a draft video
      db.ref('videos').push({
        uid: currentUser.uid,
        username: currentUser.displayName || currentUser.email.split('@')[0],
        url: 'https://picsum.photos/400/700',
        caption: 'My draft video',
        likedBy: {},
        comments: {},
        shares: 0,
        timestamp: Date.now(),
        isDraft: true,
        type: 'image'
      }).then(() => {
        showSuccess('Draft created!');
        loadProfile(currentUser.uid);
      });
    }

    // ---------- Initialize App ----------
    document.addEventListener('DOMContentLoaded', function() {
      // Add event listener for Enter key in chat
      document.getElementById('chat-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      // Add event listener for Enter key in comments
      document.getElementById('comment-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          addComment();
        }
      });

      // Initialize inbox tab functionality
      updateMessageBadge();
    });

    // ---------- Auto-play videos when they become visible ----------
    function initializeVideoAutoPlay() {
      const videoObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const video = entry.target;
          if (entry.isIntersecting) {
            video.play().catch(e => console.log('Auto-play prevented:', e));
          } else {
            video.pause();
          }
        });
      }, { threshold: 0.7 });

      // Observe all videos
      document.querySelectorAll('video').forEach(video => {
        videoObserver.observe(video);
      });
    }

    // Call this after loading videos
    setTimeout(initializeVideoAutoPlay, 1000);

  </script>
</body>
</html>
