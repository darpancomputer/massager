<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TikTok-Style Social</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif;}
    body{background:#000;color:#fff;overflow:hidden;height:100vh;display:flex;flex-direction:column;}
    header{display:flex;justify-content:space-between;align-items:center;padding:10px 15px;background:#111;position:sticky;top:0;z-index:100;}
    .logo{font-size:20px;font-weight:bold;}
    .header-icons{display:flex;gap:15px;}
    .header-icon{font-size:18px;cursor:pointer;}
    .badge{background:#ff0050;color:#fff;font-size:10px;padding:2px 6px;border-radius:12px;position:absolute;top:-5px;right:-5px;}

    /* Bottom navigation */
    .bottom-nav{display:flex;background:#111;border-top:1px solid #333;position:fixed;bottom:0;width:100%;z-index:100;}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;padding:8px 0;color:#888;cursor:pointer;}
    .nav-item.active{color:#ff0050;}
    .nav-icon{font-size:22px;margin-bottom:4px;}

    /* Pages */
    .page{display:none;flex-direction:column;height:100%;overflow:hidden;}
    .page.active{display:flex;}

    /* Video feed */
    .feed{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;scroll-snap-type:y mandatory;}
    .video-card{position:relative;width:100%;height:100vh;background:#000;scroll-snap-align:start;display:flex;align-items:center;justify-content:center;}
    video{width:100%;height:100%;object-fit:contain;background:#000;}
    .video-overlay{position:absolute;bottom:0;left:0;right:0;padding:20px 15px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.7));}
    .user-info{display:flex;align-items:center;gap:10px;color:#fff;cursor:pointer;}
    .username{font-weight:bold;}
    .caption{margin-top:5px;font-size:14px;}
    .actions{position:absolute;right:15px;bottom:80px;display:flex;flex-direction:column;gap:15px;align-items:center;}
    .action-btn{background:rgba(255,255,255,.1);width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;}
    .action-btn.liked{color:#ff0050;}
    .action-count{font-size:12px;margin-top:4px;}

    /* Profile */
    .profile-header{text-align:center;padding:20px;}
    .avatar{width:90px;height:90px;border-radius:50%;background:#333;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:40px;}
    .stats{display:flex;justify-content:center;gap:30px;margin:15px 0;}
    .stat-value{font-weight:bold;font-size:18px;}
    .stat-label{font-size:12px;color:#aaa;}
    .follow-btn{background:#ff0050;color:#fff;border:none;border-radius:4px;padding:8px 20px;cursor:pointer;}
    .follow-btn.following{background:#333;}

    /* Login / Register */
    .auth-page{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#111;}
    .auth-card{background:#222;padding:30px;border-radius:12px;width:90%;max-width:380px;text-align:center;}
    .auth-card input{width:100%;padding:12px;margin:10px 0;border-radius:6px;border:none;outline:none;}
    .auth-card button{width:100%;padding:12px;margin-top:10px;border:none;border-radius:6px;background:#ff0050;color:#fff;font-weight:bold;cursor:pointer;}

    /* Loading */
    .spinner{border:4px solid #333;border-left:4px solid #ff0050;border-radius:50%;width:36px;height:36px;animation:s 1s linear infinite;margin:20px auto;}
    @keyframes s{to{transform:rotate(360deg)}}

    /* Friends Page */
    .friends-page{background:#111;}
    .friends-tabs{display:flex;background:#111;border-bottom:1px solid #333;}
    .friends-tab{flex:1;text-align:center;padding:15px;cursor:pointer;border-bottom:2px solid transparent;}
    .friends-tab.active{color:#ff0050;border-bottom-color:#ff0050;}
    .friends-content{flex:1;overflow-y:auto;}
    .user-item{display:flex;align-items:center;padding:15px;border-bottom:1px solid #333;cursor:pointer;}
    .user-info{flex:1;margin-left:15px;}
    .user-actions{display:flex;gap:10px;}

    /* Stories Section */
    .stories-container{padding:15px;border-bottom:1px solid #333;background:#111;}
    .stories-scroll{display:flex;gap:15px;overflow-x:auto;}
    .story-item{display:flex;flex-direction:column;align-items:center;min-width:70px;}
    .story-avatar{width:60px;height:60px;border-radius:50%;background:linear-gradient(45deg,#ff0050,#ff9000);padding:3px;}
    .story-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover;border:2px solid #000;}
    .story-username{font-size:12px;margin-top:5px;max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

    /* Friends Videos Grid */
    .friends-videos{display:grid;grid-template-columns:repeat(2,1fr);gap:2px;padding:10px;}
    .friend-video{position:relative;aspect-ratio:9/16;background:#222;overflow:hidden;}
    .friend-video video{width:100%;height:100%;object-fit:cover;}
    .friend-video-overlay{position:absolute;bottom:0;left:0;right:0;padding:5px;background:rgba(0,0,0,.5);font-size:12px;}

    /* Inbox */
    .inbox-page{background:#111;}
    .inbox-tabs{display:flex;background:#111;border-bottom:1px solid #333;}
    .inbox-tab{flex:1;text-align:center;padding:15px;cursor:pointer;border-bottom:2px solid transparent;}
    .inbox-tab.active{color:#ff0050;border-bottom-color:#ff0050;}
    .inbox-content{flex:1;overflow-y:auto;}
    .request-item, .message-item{display:flex;align-items:center;padding:15px;border-bottom:1px solid #333;}
    .request-info, .message-info{flex:1;margin-left:15px;}
    .request-actions{display:flex;gap:10px;}
    .request-btn{background:#ff0050;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;}
    .request-btn.decline{background:#333;}
    .message-item{flex-direction:column;align-items:flex-start;cursor:pointer;}
    .message-header{display:flex;justify-content:space-between;width:100%;margin-bottom:5px;}
    .message-preview{color:#aaa;font-size:14px;}

    /* Chat Page - Full Screen */
    .chat-page{background:#111;position:fixed;top:0;left:0;width:100%;height:100%;z-index:1000;}
    .chat-header{display:flex;align-items:center;padding:15px;background:#111;border-bottom:1px solid #333;}
    .chat-header .avatar{width:40px;height:40px;font-size:18px;margin:0 10px 0 0;}
    .chat-messages{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;}
    .message{max-width:80%;padding:10px 15px;border-radius:18px;margin:5px 0;word-break:break-word;}
    .sent{background:#ff0050;align-self:flex-end;}
    .received{background:#333;align-self:flex-start;}
    .chat-input{display:flex;padding:10px;background:#111;gap:8px;border-top:1px solid #333;}
    .chat-input input{flex:1;padding:10px;border-radius:20px;background:#222;color:#fff;outline:none;border:none;}

    /* Profile Videos Grid */
    .profile-videos{display:grid;grid-template-columns:repeat(3,1fr);gap:2px;}
    .profile-video{position:relative;aspect-ratio:9/16;background:#222;overflow:hidden;}
    .profile-video video{width:100%;height:100%;object-fit:cover;}
    .profile-video-overlay{position:absolute;bottom:0;left:0;right:0;padding:5px;background:rgba(0,0,0,.5);font-size:12px;display:flex;align-items:center;gap:5px;}

    /* Upload Modal */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:2000;}
    .modal-content{background:#222;padding:20px;border-radius:12px;width:90%;max-width:400px;}
    .modal-options{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:20px;}
    .modal-option{background:#333;padding:20px;border-radius:8px;text-align:center;cursor:pointer;}
    .modal-option:hover{background:#444;}
    .modal-option i{font-size:24px;margin-bottom:10px;}

    /* Gallery Upload */
    .gallery-upload{background:#222;padding:20px;border-radius:12px;width:90%;max-width:500px;}
    .upload-preview{width:100%;max-height:300px;object-fit:contain;margin:10px 0;border-radius:8px;}
    .upload-options{display:flex;gap:10px;margin-top:15px;}
    .upload-option{flex:1;padding:10px;text-align:center;background:#333;border-radius:6px;cursor:pointer;}

    /* Draft Videos */
    .drafts-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:15px;}
    .draft-item{position:relative;aspect-ratio:9/16;background:#222;border-radius:8px;overflow:hidden;}
    .draft-item video{width:100%;height:100%;object-fit:cover;}
    .draft-actions{position:absolute;bottom:0;left:0;right:0;padding:10px;background:rgba(0,0,0,.7);display:flex;justify-content:space-between;}

    /* Live Streaming */
    .live-indicator{background:#ff0050;color:#fff;padding:2px 8px;border-radius:4px;font-size:12px;margin-left:10px;}
  </style>
</head>
<body>

  <!-- ==== AUTH ==== -->
  <div id="auth-page" class="page active">
    <div class="auth-card">
      <h2 style="margin-bottom:20px;">TikTok Social</h2>
      <input type="email" id="auth-email" placeholder="Email">
      <input type="password" id="auth-pass" placeholder="Password">
      <button id="login-btn">Log In</button>
      <button id="signup-btn" style="background:#333;">Create Account</button>
    </div>
  </div>

  <!-- ==== MAIN APP ==== -->
  <div id="app" class="page" style="display:none;">

    <!-- Header -->
    <header>
      <div class="logo">TikTok Social</div>
      <div class="header-icons">
        <i class="fas fa-search header-icon"></i>
        <i class="fas fa-inbox header-icon" id="inbox-btn"></i>
        <span id="msg-badge" class="badge" style="display:none;">0</span>
      </div>
    </header>

    <!-- ==== HOME / FEED ==== -->
    <div id="home-page" class="page active">
      <div class="feed" id="feed"></div>
    </div>

    <!-- ==== FRIENDS ==== -->
    <div id="friends-page" class="page friends-page">
      <div class="stories-container">
        <div class="stories-scroll" id="stories-scroll">
          <!-- Stories will be loaded here -->
        </div>
      </div>
      <div class="friends-tabs">
        <div class="friends-tab active" data-tab="videos">Friends Videos</div>
        <div class="friends-tab" data-tab="all">All Users</div>
      </div>
      <div class="friends-content" id="friends-content"></div>
    </div>

    <!-- ==== PROFILE ==== -->
    <div id="profile-page" class="page">
      <div class="profile-header">
        <div class="avatar"><i class="fas fa-user"></i></div>
        <div id="profile-username" class="username"></div>
        <div class="stats">
          <div><div id="following-count" class="stat-value">0</div><div class="stat-label">Following</div></div>
          <div><div id="followers-count" class="stat-value">0</div><div class="stat-label">Followers</div></div>
          <div><div id="likes-count" class="stat-value">0</div><div class="stat-label">Likes</div></div>
        </div>
        <button id="edit-profile-btn" class="follow-btn">Edit Profile</button>
      </div>
      <div class="profile-videos" id="profile-videos"></div>
    </div>

    <!-- ==== INBOX ==== -->
    <div id="inbox-page" class="page inbox-page">
      <div class="inbox-tabs">
        <div class="inbox-tab active" data-tab="requests">Friend Requests</div>
        <div class="inbox-tab" data-tab="messages">Messages</div>
      </div>
      <div class="inbox-content" id="inbox-content"></div>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
      <div class="nav-item active" data-page="home"><i class="fas fa-home nav-icon"></i><span>Home</span></div>
      <div class="nav-item" data-page="friends"><i class="fas fa-user-friends nav-icon"></i><span>Friends</span></div>
      <div class="nav-item" id="upload-nav" style="position:relative;top:-10px;">
        <div style="background:#ff0050;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;">
          <i class="fas fa-plus nav-icon" style="color:#fff;margin:0;"></i>
        </div>
      </div>
      <div class="nav-item" data-page="inbox"><i class="fas fa-inbox nav-icon"></i><span>Inbox</span></div>
      <div class="nav-item" data-page="profile"><i class="fas fa-user nav-icon"></i><span>Profile</span></div>
    </div>
  </div>

  <!-- ==== CHAT PAGE (Full Screen) ==== -->
  <div id="chat-page" class="page chat-page" style="display:none;">
    <div class="chat-header">
      <button id="back-from-chat" style="background:none;border:none;color:#ff0050;font-size:18px;margin-right:10px;">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="avatar"><i class="fas fa-user"></i></div>
      <div id="chat-username" class="username"></div>
    </div>
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input">
      <input id="msg-input" placeholder="Type a message...">
      <button id="send-msg" style="background:#ff0050;border:none;border-radius:50%;width:40px;height:40px;color:#fff;">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- Upload Modal -->
  <div id="upload-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3 style="text-align:center;margin-bottom:20px;">Create New Post</h3>
      <div class="modal-options">
        <div class="modal-option" id="gallery-upload-btn">
          <i class="fas fa-images"></i>
          <div>Gallery</div>
        </div>
        <div class="modal-option" id="video-upload-btn">
          <i class="fas fa-video"></i>
          <div>Video</div>
        </div>
        <div class="modal-option" id="create-draft-btn">
          <i class="fas fa-edit"></i>
          <div>Draft</div>
        </div>
        <div class="modal-option" id="view-drafts-btn">
          <i class="fas fa-folder"></i>
          <div>My Drafts</div>
        </div>
      </div>
      <button style="width:100%;padding:12px;margin-top:20px;background:#333;color:#fff;border:none;border-radius:6px;" onclick="hideModal()">Cancel</button>
    </div>
  </div>

  <!-- Gallery Upload Modal -->
  <div id="gallery-modal" class="modal" style="display:none;">
    <div class="gallery-upload">
      <h3 style="text-align:center;margin-bottom:15px;">Upload from Gallery</h3>
      <input type="file" id="media-file" accept="image/*,video/*" style="display:none;">
      <div style="border:2px dashed #555;padding:40px;text-align:center;border-radius:8px;cursor:pointer;" onclick="document.getElementById('media-file').click()">
        <i class="fas fa-cloud-upload-alt" style="font-size:48px;color:#555;margin-bottom:10px;"></i>
        <div>Click to select photo or video</div>
      </div>
      <img id="upload-preview" class="upload-preview" style="display:none;">
      <div id="video-preview" style="display:none;"></div>
      <input type="text" id="upload-caption" placeholder="Add caption..." style="width:100%;padding:10px;margin:10px 0;background:#333;border:none;border-radius:6px;color:#fff;">
      <div class="upload-options">
        <div class="upload-option" onclick="uploadMedia()" style="background:#ff0050;">Upload</div>
        <div class="upload-option" onclick="hideModal()">Cancel</div>
      </div>
    </div>
  </div>

  <!-- Drafts Modal -->
  <div id="drafts-modal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:500px;">
      <h3 style="text-align:center;margin-bottom:20px;">My Drafts</h3>
      <div class="drafts-grid" id="drafts-container">
        <!-- Drafts will be loaded here -->
      </div>
      <button style="width:100%;padding:12px;margin-top:20px;background:#333;color:#fff;border:none;border-radius:6px;" onclick="hideModal()">Close</button>
    </div>
  </div>

  <!-- ==== Firebase ==== -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // ---------- Firebase Config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDYwtq05q9qXhrNVJ4I-I-LuD1dpp2Suk8",
      authDomain: "massage-8c66f.firebaseapp.com",
      databaseURL: "https://massage-8c66f-default-rtdb.firebaseio.com",
      projectId: "massage-8c66f",
      storageBucket: "massage-8c66f.firebasestorage.app",
      messagingSenderId: "557008720018",
      appId: "1:557008720018:web:22055db26bbfb2bab3d64b"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ---------- Global ----------
    let currentUser = null;
    let currentChatUid = null;
    let selectedMediaFile = null;
    const pages = {
      auth: document.getElementById('auth-page'),
      home: document.getElementById('home-page'),
      friends: document.getElementById('friends-page'),
      profile: document.getElementById('profile-page'),
      inbox: document.getElementById('inbox-page'),
      chat: document.getElementById('chat-page')
    };

    // ---------- Auth ----------
    document.getElementById('login-btn').onclick = () => login();
    document.getElementById('signup-btn').onclick = () => signup();

    function login() {
      const email = document.getElementById('auth-email').value.trim();
      const pass  = document.getElementById('auth-pass').value;
      if (!email || !pass) return alert('Fill all fields');
      auth.signInWithEmailAndPassword(email, pass)
        .then(cred => afterAuth(cred.user))
        .catch(err => alert(err.message));
    }
    
    function signup() {
      const email = document.getElementById('auth-email').value.trim();
      const pass  = document.getElementById('auth-pass').value;
      const username = prompt('Choose a username:');
      if (!email || !pass || !username) return alert('All fields required');
      auth.createUserWithEmailAndPassword(email, pass)
        .then(cred => {
          return db.ref('users/' + cred.user.uid).set({
            username, email, following: {}, followers: {}, likes: 0, friends: {}
          }).then(() => afterAuth(cred.user));
        })
        .catch(err => alert(err.message));
    }
    
    function afterAuth(user) {
      currentUser = user;
      pages.auth.classList.remove('active');
      document.getElementById('app').style.display = 'flex';
      showPage('home');
      loadGlobalFeed();
      loadProfile(user.uid);
      updateMessageBadge();
    }
    
    auth.onAuthStateChanged(user => {
      if (!user) {
        document.getElementById('app').style.display = 'none';
        pages.auth.classList.add('active');
      }
    });

    // ---------- Navigation ----------
    document.querySelectorAll('.nav-item').forEach(el => {
      if (el.id !== 'upload-nav') {
        el.addEventListener('click', () => {
          const p = el.dataset.page;
          showPage(p);
          document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
          el.classList.add('active');
          
          if (p === 'inbox') {
            loadInbox();
          } else if (p === 'friends') {
            loadFriendsPage();
          }
        });
      }
    });

    // Upload button
    document.getElementById('upload-nav').onclick = () => {
      showModal('upload-modal');
    };

    function showPage(name) {
      // Hide chat page first if showing
      if (name !== 'chat') {
        pages.chat.style.display = 'none';
      }
      
      Object.values(pages).forEach(p => {
        if (p !== pages.chat) {
          p.classList.remove('active');
        }
      });
      
      if (name !== 'chat') {
        pages[name].classList.add('active');
      }
    }

    // ---------- Modal Functions ----------
    function showModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }

    function hideModal() {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
      });
      // Reset file input
      document.getElementById('media-file').value = '';
      document.getElementById('upload-preview').style.display = 'none';
      document.getElementById('video-preview').style.display = 'none';
      document.getElementById('upload-caption').value = '';
      selectedMediaFile = null;
    }

    // Upload modal options
    document.getElementById('gallery-upload-btn').onclick = () => {
      hideModal();
      showModal('gallery-modal');
    };

    document.getElementById('video-upload-btn').onclick = () => {
      hideModal();
      uploadVideo();
    };

    document.getElementById('create-draft-btn').onclick = () => {
      hideModal();
      createDraft();
    };

    document.getElementById('view-drafts-btn').onclick = () => {
      hideModal();
      showDrafts();
    };

    // File input handler
    document.getElementById('media-file').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        selectedMediaFile = file;
        const preview = document.getElementById('upload-preview');
        const videoPreview = document.getElementById('video-preview');
        
        if (file.type.startsWith('image/')) {
          preview.src = URL.createObjectURL(file);
          preview.style.display = 'block';
          videoPreview.style.display = 'none';
        } else if (file.type.startsWith('video/')) {
          videoPreview.innerHTML = `<video controls class="upload-preview"><source src="${URL.createObjectURL(file)}" type="${file.type}"></video>`;
          videoPreview.style.display = 'block';
          preview.style.display = 'none';
        }
      }
    });

    // ---------- Video Feed ----------
    let lastVideoKey = null;
    function loadGlobalFeed() {
      const feedContainer = document.getElementById('feed');
      feedContainer.innerHTML = '<div class="spinner"></div>';
      let ref = db.ref('videos').orderByChild('timestamp').limitToLast(10);
      if (lastVideoKey) ref = ref.endBefore(lastVideoKey);
      ref.once('value').then(snap => {
        const videos = snap.val() || {};
        const keys = Object.keys(videos).reverse();
        if (keys.length) lastVideoKey = keys[keys.length-1];
        renderVideos(videos, feedContainer, true);
      });
    }

    function renderVideos(videosObj, container, isGlobal = false) {
      if (!Object.keys(videosObj).length) {
        container.innerHTML = '<div style="color:#aaa;text-align:center;padding:30px;">No videos yet</div>';
        return;
      }
      const fragment = document.createDocumentFragment();
      Object.entries(videosObj).reverse().forEach(([vid, data]) => {
        // Skip drafts in main feed
        if (data.isDraft) return;

        const card = document.createElement('div');
        card.className = 'video-card';
        card.innerHTML = `
          <video src="${data.url}" loop playsinline></video>
          <div class="video-overlay">
            <div class="user-info">
              <div class="avatar"><i class="fas fa-user"></i></div>
              <div>
                <div class="username">@${data.username}</div>
                <div class="caption">${escape(data.caption||'')}</div>
              </div>
            </div>
          </div>
          <div class="actions">
            <div class="action-btn like-btn ${data.likedBy?.[currentUser.uid]?'liked':''}" data-vid="${vid}">
              <i class="fas fa-heart"></i>
              <div class="action-count">${Object.keys(data.likedBy||{}).length}</div>
            </div>
            <div class="action-btn comment-btn"><i class="fas fa-comment"></i><div class="action-count">0</div></div>
            <div class="action-btn share-btn"><i class="fas fa-share"></i></div>
          </div>
        `;
        const video = card.querySelector('video');
        const likeBtn = card.querySelector('.like-btn');

        // Play / pause on visibility
        const observer = new IntersectionObserver(entries => {
          entries.forEach(e => {
            if (e.isIntersecting) video.play();
            else video.pause();
          });
        }, {threshold: 0.7});
        observer.observe(card);

        // Like
        likeBtn.onclick = () => toggleLike(vid, likeBtn, data);

        // Click user â†’ profile
        card.querySelector('.user-info').onclick = () => {
          loadProfile(data.uid);
          showPage('profile');
        };

        fragment.appendChild(card);
      });
      container.innerHTML = '';
      container.appendChild(fragment);
    }

    async function toggleLike(vid, btn, data) {
      const uid = currentUser.uid;
      const liked = !!data.likedBy?.[uid];
      const updates = {};
      if (liked) {
        updates[`videos/${vid}/likedBy/${uid}`] = null;
        updates[`users/${data.uid}/likes`] = firebase.database.ServerValue.increment(-1);
      } else {
        updates[`videos/${vid}/likedBy/${uid}`] = true;
        updates[`users/${data.uid}/likes`] = firebase.database.ServerValue.increment(1);
      }
      await db.ref().update(updates);
      btn.classList.toggle('liked');
      const countEl = btn.querySelector('.action-count');
      countEl.textContent = (Object.keys(data.likedBy||{}).length + (liked?-1:1));
    }

    // ---------- Friends Page ----------
    function loadFriendsPage() {
      loadStories();
      const activeTab = document.querySelector('.friends-tab.active').dataset.tab;
      const content = document.getElementById('friends-content');
      
      if (activeTab === 'videos') {
        loadFriendsVideos(content);
      } else {
        loadAllUsers(content);
      }
    }

    function loadStories() {
      const storiesContainer = document.getElementById('stories-scroll');
      storiesContainer.innerHTML = '<div class="spinner"></div>';
      
      // Get friends for stories
      db.ref('users/' + currentUser.uid + '/friends').once('value').then(snap => {
        const friends = snap.val() || {};
        storiesContainer.innerHTML = '';
        
        Object.keys(friends).forEach(fid => {
          db.ref('users/' + fid).once('value').then(userSnap => {
            const user = userSnap.val();
            if (!user) return;
            
            // Check if user has recent videos for stories
            db.ref('videos').orderByChild('uid').equalTo(fid).limitToLast(1).once('value').then(videoSnap => {
              const videos = videoSnap.val() || {};
              if (Object.keys(videos).length > 0) {
                const storyEl = document.createElement('div');
                storyEl.className = 'story-item';
                storyEl.innerHTML = `
                  <div class="story-avatar">
                    <i class="fas fa-user" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:24px;"></i>
                  </div>
                  <div class="story-username">${user.username}</div>
                `;
                storyEl.onclick = () => viewFriendVideos(fid, user.username);
                storiesContainer.appendChild(storyEl);
              }
            });
          });
        });
      });
    }

    function loadFriendsVideos(container) {
      container.innerHTML = '<div class="spinner"></div>';
      
      // Get friends
      db.ref('users/' + currentUser.uid + '/friends').once('value').then(snap => {
        const friends = snap.val() || {};
        container.innerHTML = '';
        
        if (Object.keys(friends).length === 0) {
          container.innerHTML = '<div style="color:#aaa;text-align:center;padding:30px;">No friends yet</div>';
          return;
        }
        
        // Get videos from friends
        const friendsVideos = [];
        Object.keys(friends).forEach(fid => {
          db.ref('videos').orderByChild('uid').equalTo(fid).once('value').then(videoSnap => {
            const videos = videoSnap.val() || {};
            Object.entries(videos).forEach(([vid, video]) => {
              if (!video.isDraft) {
                friendsVideos.push({vid, ...video});
              }
            });
            
            // Render all collected videos
            renderFriendsVideos(friendsVideos, container);
          });
        });
      });
    }

    function renderFriendsVideos(videos, container) {
      if (videos.length === 0) {
        container.innerHTML = '<div style="color:#aaa;text-align:center;padding:30px;">No videos from friends</div>';
        return;
      }
      
      // Sort by timestamp
      videos.sort((a, b) => b.timestamp - a.timestamp);
      
      container.innerHTML = '<div class="friends-videos" id="friends-videos-grid"></div>';
      const grid = document.getElementById('friends-videos-grid');
      
      videos.forEach(video => {
        const videoEl = document.createElement('div');
        videoEl.className = 'friend-video';
        videoEl.innerHTML = `
          <video src="${video.url}" loop muted></video>
          <div class="friend-video-overlay">
            <i class="fas fa-heart"></i> ${Object.keys(video.likedBy||{}).length}
          </div>
        `;
        videoEl.onclick = () => playFriendVideo(video);
        grid.appendChild(videoEl);
      });
    }

    function viewFriendVideos(fid, username) {
      // Show all videos from this friend
      const container = document.getElementById('friends-content');
      container.innerHTML = '<div class="spinner"></div>';
      
      db.ref('videos').orderByChild('uid').equalTo(fid).once('value').then(videoSnap => {
        const videos = videoSnap.val() || {};
        container.innerHTML = `
          <div style="padding:15px;background:#111;border-bottom:1px solid #333;">
            <button onclick="loadFriendsPage()" style="background:none;border:none;color:#ff0050;font-size:16px;">
              <i class="fas fa-arrow-left"></i> Back
            </button>
            <h3 style="margin:10px 0;">@${username}'s Videos</h3>
          </div>
          <div class="friends-videos" id="friend-videos-grid"></div>
        `;
        
        const grid = document.getElementById('friend-videos-grid');
        Object.entries(videos).reverse().forEach(([vid, video]) => {
          if (!video.isDraft) {
            const videoEl = document.createElement('div');
            videoEl.className = 'friend-video';
            videoEl.innerHTML = `
              <video src="${video.url}" loop muted></video>
              <div class="friend-video-overlay">
                <i class="fas fa-heart"></i> ${Object.keys(video.likedBy||{}).length}
              </div>
            `;
            videoEl.onclick = () => playFriendVideo(video);
            grid.appendChild(videoEl);
          }
        });
        
        if (grid.innerHTML === '') {
          grid.innerHTML = '<div style="color:#aaa;text-align:center;padding:30px;grid-column:1/-1;">No videos</div>';
        }
      });
    }

    function playFriendVideo(video) {
      // Play video in full screen view (simplified)
      const container = document.getElementById('friends-content');
      container.innerHTML = `
        <div style="position:relative;height:100%;background:#000;">
          <button onclick="viewFriendVideos('${video.uid}', '${video.username}')" style="position:absolute;top:15px;left:15px;background:rgba(0,0,0,.5);color:#fff;border:none;border-radius:50%;width:40px;height:40px;z-index:10;">
            <i class="fas fa-arrow-left"></i>
          </button>
          <video src="${video.url}" loop controls autoplay style="width:100%;height:100%;object-fit:contain;"></video>
          <div style="position:absolute;bottom:0;left:0;right:0;padding:20px;background:linear-gradient(transparent,rgba(0,0,0,.7));">
            <div class="username">@${video.username}</div>
            <div class="caption">${escape(video.caption||'')}</div>
          </div>
        </div>
      `;
    }

    function loadAllUsers(container) {
      container.innerHTML = '<div class="spinner"></div>';
      db.ref('users').once('value').then(snap => {
        const users = snap.val() || {};
        container.innerHTML = '';
        
        Object.entries(users).forEach(([uid, user]) => {
          if (uid === currentUser.uid) return;
          
          const isFollowing = !!user.followers?.[currentUser.uid];
          const isFriend = !!user.friends?.[currentUser.uid];
          
          const userEl = document.createElement('div');
          userEl.className = 'user-item';
          userEl.innerHTML = `
            <div class="avatar"><i class="fas fa-user"></i></div>
            <div class="user-info">
              <div class="username">@${user.username}</div>
              <div style="color:#aaa;font-size:12px;">${user.email}</div>
            </div>
            <div class="user-actions">
              ${isFriend ? 
                '<button class="request-btn" style="background:#333;">Friends</button>' :
                `<button class="request-btn ${isFollowing ? 'following' : ''}" data-uid="${uid}">
                  ${isFollowing ? 'Following' : 'Follow'}
                </button>`
              }
            </div>
          `;
          
          const followBtn = userEl.querySelector('.request-btn');
          if (!isFriend) {
            followBtn.onclick = () => sendFriendRequest(uid, user);
          }
          
          // Click on user item to view profile
          userEl.querySelector('.user-info').onclick = () => {
            loadProfile(uid);
            showPage('profile');
          };
          
          container.appendChild(userEl);
        });
      });
    }

    function sendFriendRequest(targetUid, targetUser) {
      const updates = {};
      updates[`users/${currentUser.uid}/following/${targetUid}`] = true;
      updates[`users/${targetUid}/followers/${currentUser.uid}`] = true;
      
      // Send friend request
      updates[`friendRequests/${targetUid}/${currentUser.uid}`] = {
        from: currentUser.uid,
        username: currentUser.displayName || currentUser.email.split('@')[0],
        timestamp: Date.now()
      };
      
      db.ref().update(updates).then(() => {
        loadFriendsPage();
        updateMessageBadge();
      });
    }

    // Friends tabs
    document.querySelectorAll('.friends-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.friends-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        loadFriendsPage();
      });
    });

    // ---------- Profile ----------
    async function loadProfile(uid) {
      const snap = await db.ref('users/' + uid).once('value');
      const user = snap.val();
      if (!user) return;
      
      document.getElementById('profile-username').textContent = '@' + user.username;
      document.getElementById('following-count').textContent = Object.keys(user.following||{}).length;
      document.getElementById('followers-count').textContent = Object.keys(user.followers||{}).length;
      document.getElementById('likes-count').textContent = user.likes || 0;

      const editBtn = document.getElementById('edit-profile-btn');
      if (uid === currentUser.uid) {
        editBtn.textContent = 'Edit Profile';
        editBtn.onclick = () => editProfile();
      } else {
        const isFriend = !!user.friends?.[currentUser.uid];
        const isFollowing = !!user.followers?.[currentUser.uid];
        editBtn.textContent = isFriend ? 'Friends' : (isFollowing ? 'Following' : 'Follow');
        editBtn.className = 'follow-btn ' + (isFriend ? 'following' : (isFollowing ? 'following' : ''));
        editBtn.onclick = () => toggleFollow(uid, editBtn, user);
      }

      // Load user videos in grid format
      const profileVideos = document.getElementById('profile-videos');
      profileVideos.innerHTML = '<div class="spinner"></div>';
      db.ref('videos').orderByChild('uid').equalTo(uid).once('value').then(s => {
        const videos = s.val() || {};
        renderProfileVideos(videos, uid === currentUser.uid);
      });
    }
    
    function renderProfileVideos(videosObj, isOwnProfile = false) {
      const profileVideos = document.getElementById('profile-videos');
      
      if (!Object.keys(videosObj).length) {
        profileVideos.innerHTML = '<div style="color:#aaa;text-align:center;padding:30px;grid-column:1/-1;">No videos yet</div>';
        return;
      }
      
      profileVideos.innerHTML = '';
      Object.entries(videosObj).reverse().forEach(([vid, data]) => {
        // Don't show drafts to other users
        if (data.isDraft && !isOwnProfile) return;
        
        const videoEl = document.createElement('div');
        videoEl.className = 'profile-video';
        videoEl.innerHTML = `
          <video src="${data.url}" loop muted></video>
          <div class="profile-video-overlay">
            <i class="fas fa-heart"></i> ${Object.keys(data.likedBy||{}).length}
            ${data.isDraft ? '<i class="fas fa-edit" style="margin-left:10px;"></i> Draft' : ''}
          </div>
        `;
        
        if (isOwnProfile && data.isDraft) {
          const actions = document.createElement('div');
          actions.className = 'draft-actions';
          actions.innerHTML = `
            <button onclick="postDraft('${vid}')" style="background:#ff0050;color:#fff;border:none;padding:5px 10px;border-radius:4px;font-size:12px;">Post</button>
            <button onclick="deleteDraft('${vid}')" style="background:#333;color:#fff;border:none;padding:5px 10px;border-radius:4px;font-size:12px;">Delete</button>
          `;
          videoEl.appendChild(actions);
        }
        
        profileVideos.appendChild(videoEl);
      });
    }
    
    async function toggleFollow(targetUid, btn, targetData) {
      const meFollowing = !!targetData.followers?.[currentUser.uid];
      const updates = {};
      
      if (meFollowing) {
        updates[`users/${currentUser.uid}/following/${targetUid}`] = null;
        updates[`users/${targetUid}/followers/${currentUser.uid}`] = null;
        
        // Remove from friends if they were friends
        updates[`users/${currentUser.uid}/friends/${targetUid}`] = null;
        updates[`users/${targetUid}/friends/${currentUser.uid}`] = null;
      } else {
        updates[`users/${currentUser.uid}/following/${targetUid}`] = true;
        updates[`users/${targetUid}/followers/${currentUser.uid}`] = true;
        
        // Check if it's mutual follow to make friends
        const myData = await db.ref('users/' + currentUser.uid).once('value');
        if (myData.val().following && myData.val().following[targetUid] && targetData.followers && targetData.followers[currentUser.uid]) {
          updates[`users/${currentUser.uid}/friends/${targetUid}`] = true;
          updates[`users/${targetUid}/friends/${currentUser.uid}`] = true;
        }
      }
      
      await db.ref().update(updates);
      loadProfile(targetUid);
      updateMessageBadge();
    }

    function editProfile() {
      const newUsername = prompt('Enter new username:');
      if (newUsername) {
        db.ref('users/' + currentUser.uid + '/username').set(newUsername);
        loadProfile(currentUser.uid);
      }
    }

    // ---------- Inbox ----------
    function loadInbox() {
      const activeTab = document.querySelector('.inbox-tab.active').dataset.tab;
      const content = document.getElementById('inbox-content');
      
      if (activeTab === 'requests') {
        loadFriendRequests(content);
      } else {
        loadMessageList(content);
      }
    }
    
    function loadFriendRequests(container) {
      container.innerHTML = '<div class="spinner"></div>';
      
      db.ref('friendRequests/' + currentUser.uid).once('value').then(snap => {
        const requests = snap.val() || {};
        
        if (!Object.keys(requests).length) {
          container.innerHTML = '<div style="color:#aaa;text-align:center;padding:30px;">No friend requests</div>';
          return;
        }
        
        container.innerHTML = '';
        Object.entries(requests).forEach(([fromUid, req]) => {
          db.ref('users/' + fromUid).once('value').then(userSnap => {
            const user = userSnap.val();
            if (!user) return;
            
            const reqEl = document.createElement('div');
            reqEl.className = 'request-item';
            reqEl.innerHTML = `
              <div class="avatar"><i class="fas fa-user"></i></div>
              <div class="request-info">
                <div class="username">@${user.username}</div>
                <div style="color:#aaa;font-size:12px;">Wants to be friends</div>
              </div>
              <div class="request-actions">
                <button class="request-btn accept" data-uid="${fromUid}">Accept</button>
                <button class="request-btn decline" data-uid="${fromUid}">Delete</button>
              </div>
            `;
            container.appendChild(reqEl);
            
            // Add event listeners
            reqEl.querySelector('.accept').onclick = () => acceptFriendRequest(fromUid);
            reqEl.querySelector('.decline').onclick = () => declineFriendRequest(fromUid);
          });
        });
      });
    }
    
    function loadMessageList(container) {
      container.innerHTML = '<div class="spinner"></div>';
      
      // Get all friends
      db.ref('users/' + currentUser.uid + '/friends').once('value').then(snap => {
        const friends = snap.val() || {};
        
        if (Object.keys(friends).length === 0) {
          container.innerHTML = '<div style="color:#aaa;text-align:center;padding:30px;">No messages</div>';
          return;
        }
        
        container.innerHTML = '';
        Object.keys(friends).forEach(uid => {
          db.ref('users/' + uid).once('value').then(userSnap => {
            const u = userSnap.val();
            if (!u) return;
            
            // Get last message
            const chatId = [currentUser.uid, uid].sort().join('_');
            db.ref('chats/' + chatId).orderByKey().limitToLast(1).once('value').then(msgSnap => {
              const messages = msgSnap.val() || {};
              const lastMsg = Object.values(messages)[0] || {text: 'No messages yet'};
              
              const msgEl = document.createElement('div');
              msgEl.className = 'message-item';
              msgEl.innerHTML = `
                <div class="avatar"><i class="fas fa-user"></i></div>
                <div class="message-info">
                  <div class="message-header">
                    <div class="username">@${u.username}</div>
                  </div>
                  <div class="message-preview">${escape(lastMsg.text)}</div>
                </div>
              `;
              msgEl.onclick = () => openChat(uid, u.username);
              container.appendChild(msgEl);
            });
          });
        });
      });
    }
    
    function acceptFriendRequest(fromUid) {
      const updates = {};
      updates[`friendRequests/${currentUser.uid}/${fromUid}`] = null;
      updates[`users/${currentUser.uid}/friends/${fromUid}`] = true;
      updates[`users/${fromUid}/friends/${currentUser.uid}`] = true;
      
      db.ref().update(updates).then(() => {
        loadInbox();
        updateMessageBadge();
      });
    }
    
    function declineFriendRequest(fromUid) {
      db.ref(`friendRequests/${currentUser.uid}/${fromUid}`).remove().then(() => {
        loadInbox();
        updateMessageBadge();
      });
    }
    
    // Inbox tabs
    document.querySelectorAll('.inbox-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.inbox-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        loadInbox();
      });
    });

    // ---------- Chat (Full Screen) ----------
    function openChat(uid, username) {
      currentChatUid = uid;
      document.getElementById('chat-username').textContent = '@' + username;
      
      // Hide main app and show chat page
      document.getElementById('app').style.display = 'none';
      pages.chat.style.display = 'flex';
      
      loadMessages(uid);
    }
    
    function loadMessages(uid) {
      const chatId = [currentUser.uid, uid].sort().join('_');
      const messagesContainer = document.getElementById('chat-messages');
      messagesContainer.innerHTML = '';
      
      // Clear previous listeners
      db.ref('chats/' + chatId).off();
      
      db.ref('chats/' + chatId).on('child_added', s => {
        const m = s.val();
        const div = document.createElement('div');
        div.className = 'message ' + (m.sender===currentUser.uid?'sent':'received');
        div.innerHTML = escape(m.text);
        messagesContainer.appendChild(div);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });
    }
    
    document.getElementById('send-msg').onclick = () => {
      const txt = document.getElementById('msg-input').value.trim();
      if (!txt || !currentChatUid) return;
      const chatId = [currentUser.uid, currentChatUid].sort().join('_');
      db.ref('chats/' + chatId).push({
        sender: currentUser.uid,
        text: txt,
        ts: Date.now()
      });
      document.getElementById('msg-input').value = '';
    };
    
    document.getElementById('back-from-chat').onclick = () => {
      // Show main app and hide chat page
      document.getElementById('app').style.display = 'flex';
      pages.chat.style.display = 'none';
      showPage('inbox');
    };

    // ---------- Upload Functions ----------
    function uploadMedia() {
      if (!selectedMediaFile) {
        alert('Please select a file first');
        return;
      }

      const caption = document.getElementById('upload-caption').value;
      
      // For demo, we'll use a placeholder URL since we can't actually upload files
      // In a real app, you would upload to Firebase Storage
      const demoUrl = selectedMediaFile.type.startsWith('video/') 
        ? 'https://assets.mixkit.co/videos/preview/mixkit-tree-with-yellow-flowers-1173-large.mp4'
        : 'https://picsum.photos/400/700';
      
      db.ref('videos').push({
        uid: currentUser.uid,
        username: currentUser.displayName || currentUser.email.split('@')[0],
        url: demoUrl, 
        caption,
        likedBy: {}, 
        timestamp: Date.now(),
        isDraft: false,
        type: selectedMediaFile.type.startsWith('video/') ? 'video' : 'image'
      }).then(() => {
        alert('Media uploaded successfully!');
        hideModal();
        loadProfile(currentUser.uid);
      });
    }

    function uploadVideo() {
      const url = prompt('Paste video URL (any public mp4):');
      const caption = prompt('Caption:');
      if (!url) return;
      
      db.ref('videos').push({
        uid: currentUser.uid,
        username: currentUser.displayName || currentUser.email.split('@')[0],
        url, 
        caption,
        likedBy: {}, 
        timestamp: Date.now(),
        isDraft: false,
        type: 'video'
      }).then(() => alert('Video uploaded!'));
    }

    function createDraft() {
      const url = prompt('Paste media URL for draft:');
      const caption = prompt('Caption (optional):');
      if (!url) return;
      
      db.ref('videos').push({
        uid: currentUser.uid,
        username: currentUser.displayName || currentUser.email.split('@')[0],
        url, 
        caption: caption || '',
        likedBy: {}, 
        timestamp: Date.now(),
        isDraft: true
      }).then(() => alert('Draft saved!'));
    }

    function showDrafts() {
      showModal('drafts-modal');
      loadDrafts();
    }

    function loadDrafts() {
      const container = document.getElementById('drafts-container');
      container.innerHTML = '<div class="spinner"></div>';
      
      db.ref('videos').orderByChild('uid').equalTo(currentUser.uid).once('value').then(snap => {
        const videos = snap.val() || {};
        container.innerHTML = '';
        
        Object.entries(videos).forEach(([vid, data]) => {
          if (!data.isDraft) return;
          
          const draftEl = document.createElement('div');
          draftEl.className = 'draft-item';
          draftEl.innerHTML = `
            <video src="${data.url}" loop muted></video>
            <div class="draft-actions">
              <button onclick="postDraft('${vid}')" style="background:#ff0050;color:#fff;border:none;padding:5px 10px;border-radius:4px;font-size:12px;">Post</button>
              <button onclick="deleteDraft('${vid}')" style="background:#333;color:#fff;border:none;padding:5px 10px;border-radius:4px;font-size:12px;">Delete</button>
            </div>
          `;
          container.appendChild(draftEl);
        });
        
        if (container.innerHTML === '') {
          container.innerHTML = '<div style="color:#aaa;text-align:center;padding:30px;grid-column:1/-1;">No drafts</div>';
        }
      });
    }

    function postDraft(vid) {
      db.ref('videos/' + vid + '/isDraft').set(false);
      hideModal();
      alert('Draft posted!');
      loadProfile(currentUser.uid);
    }

    function deleteDraft(vid) {
      if (confirm('Delete this draft?')) {
        db.ref('videos/' + vid).remove();
        hideModal();
        loadProfile(currentUser.uid);
      }
    }

    // ---------- Message Badge ----------
    function updateMessageBadge() {
      db.ref('friendRequests/' + currentUser.uid).once('value').then(snap => {
        const requests = snap.val() || {};
        const badge = document.getElementById('msg-badge');
        
        if (Object.keys(requests).length > 0) {
          badge.textContent = Object.keys(requests).length;
          badge.style.display = 'block';
        } else {
          badge.style.display = 'none';
        }
      });
    }

    // ---------- Utils ----------
    function escape(s){return s?s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]):'';}

    // Listen for new videos
    db.ref('videos').orderByChild('timestamp').limitToLast(1).on('child_added', () => {
      if (pages.home.classList.contains('active')) {
        loadGlobalFeed();
      }
    });

    // Auto update message badge
    setInterval(updateMessageBadge, 5000);

  </script>
</body>
</html>
